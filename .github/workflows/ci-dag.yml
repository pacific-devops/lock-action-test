name: ci-dags

on:
  workflow_call:
    inputs:
      deployment-id:
        required: true
        type: string

permissions:
  contents: read

jobs:
  lock-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout storage repo
        uses: actions/checkout@v4
        with:
          path: main
      - name: Checkout storage repo
        uses: actions/checkout@v4
        with:
          repository: pacific-devops/lock-action-test
          token: ${{ secrets.GH_PAT }}
          path: storage
      - name: Acquire branch lock
        uses: suzuki-shunsuke/lock-action@8f08ca10332ee4ed22fd6f90508c179176da9d6d
        with:
          github_token: ${{ secrets.GH_PAT }}
          repo_name: lock-action-test
          mode: lock
          key: ${{ inputs.deployment-id }}
          message: "Deployment locked by repo=${{ github.repository }},branch=${{ github.ref_name }},run_url=${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          # post_unlock: true
          # max_wait_seconds: 600
          # wait_interval_seconds: 10
          remove_key_when_unlock: false
          key_prefix: lock__
          ignore_already_locked_error: false
          fail_if_locked: false

      # 3) Simulate DAG work (write a file into the checked-out repo)
      - name: Simulate DAG sync (create file)
        working-directory: ${{ github.workspace }}/storage
        run: |
          mkdir -p dags/test
          echo "repo=${{ github.repository }}" > dags/test/.last_deploy
          echo "branch=${{ github.ref_name }}" >> dags/test/.last_deploy
          echo "sha=${{ github.sha }}" >> dags/test/.last_deploy
          echo "run_id=${{ github.run_id }}" >> dags/test/.last_deploy
          echo "deployed_at=$(date -u +"%Y-%m-%dT%H:%M:%SZ")" >> dags/test/.last_deploy

      - name: Commit & Push changes
        id: commit_push
        working-directory: ${{ github.workspace }}/storage
        env:
          DEPLOYMENT_ID: ${{ inputs.deployment-id }}   # or inputs.deployment-id
        run: |
          git config user.name "ci-bot"
          git config user.email "ci-bot@users.noreply.github.com"
      
          # Ensure we are on the deployment branch (create if missing)
          git checkout -B "$DEPLOYMENT_ID"
      
          git add .
          if git diff-index --quiet HEAD; then
            echo "pushed=false" >> $GITHUB_OUTPUT
            echo "No changes to push."
          else
            git commit -m "chore: push DAGs from ${{ github.repository }}@${GITHUB_SHA}"
            git push -u origin "$DEPLOYMENT_ID"
            echo "pushed=true" >> $GITHUB_OUTPUT
          fi

      - name: Debug list lock branches
        if: steps.commit_push.conclusion == 'success'
        run: |
          set -e
      
          OWNER="pacific-devops"
          REPO="lock-action-test"
          LOCK_REF="lock__${{ inputs.deployment-id }}"
      
          echo "Attempting to unlock ref: ${LOCK_REF}"
      
          for i in 1 2 3 4 5; do
            echo "Unlock attempt #$i..."
      
            if gh api -X DELETE "repos/${OWNER}/${REPO}/git/refs/heads/${LOCK_REF}"; then
              echo "✅ Unlocked successfully: ${LOCK_REF}"
              exit 0
            fi
      
            echo "⚠️ Unlock failed (likely throttled). Waiting 15s before retry..."
            sleep 15
          done
      
          echo "❌ Failed to unlock after multiple attempts. Manual cleanup may be required."
          # Do not fail the job; we don't want post-cleanup to break the pipeline
          exit 0
        env:
          GH_TOKEN:  ${{ secrets.GH_PAT }}
           
